<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="ä¸€ä¸ªç®€å•å®ç”¨çš„å–æ°´æé†’æ‰“å¡åº”ç”¨ï¼Œå¸®åŠ©æ‚¨å…»æˆè‰¯å¥½çš„å–æ°´ä¹ æƒ¯">
    <meta name="theme-color" content="#0f2027">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å–æ°´æ‰“å¡">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

    <title>å–æ°´æ‰“å¡</title>
    <link rel="stylesheet" href="glassmorphism.css">
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>ğŸ’§ å–æ°´æ‰“å¡</h1>
            <div class="date" id="currentDate"></div>
        </div>

        <!-- å®‰è£…æç¤º -->
        <div class="install-prompt" id="installPrompt">
            <div class="install-prompt-text">
                ğŸ“± æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œåƒ APP ä¸€æ ·ä½¿ç”¨
            </div>
            <button class="install-btn" id="installButton">å®‰è£…</button>
            <button class="close-prompt" id="closePrompt">Ã—</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="todayCount">0</div>
                <div class="stat-label">ä»Šæ—¥æ‰“å¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">æ€»è®¡æ‰“å¡</div>
            </div>
            <div class="stat-card full-width">
                <svg class="progress-ring">
                    <defs>
                        <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#60efff;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#00d4ff;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="progress-ring-circle"
                            stroke-dasharray="314 314"
                            stroke-dashoffset="314"
                            cx="60" cy="60" r="50"
                            id="progressCircle">
                    </circle>
                </svg>
                <div class="progress-text" id="progressText">0/8</div>
                <div class="stat-label">ä»Šæ—¥ç›®æ ‡</div>
            </div>
        </div>

        <div class="check-in-section">
            <button class="check-in-btn" id="checkInBtn">
                <span class="btn-icon">ğŸ’§</span>
                <span class="btn-text">æ‰“å¡å–æ°´</span>
            </button>
        </div>

        <div class="records-section">
            <div class="section-header">
                <h2>ä»Šæ—¥è®°å½•</h2>
                <button class="clear-btn" id="clearBtn">æ¸…ç©ºè®°å½•</button>
            </div>
            <div class="records-list" id="recordsList">
                <p class="no-records">è¿˜æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œå¿«æ¥å–æ°´å§ï¼</p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const STORAGE_KEY = 'drinkWaterRecords';
        const DAILY_GOAL = 8;
        let deferredPrompt;

        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration);
                    })
                    .catch(error => {
                        console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                    });
            });
        }

        // PWA å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installButton').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`ç”¨æˆ·é€‰æ‹©: ${outcome}`);
                deferredPrompt = null;
                document.getElementById('installPrompt').classList.remove('show');
            }
        });

        document.getElementById('closePrompt').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.remove('show');
        });

        // åº”ç”¨åˆå§‹åŒ–
        function init() {
            updateDate();
            updateStats();
            loadRecords();

            document.getElementById('checkInBtn').addEventListener('click', handleCheckIn);
            document.getElementById('clearBtn').addEventListener('click', handleClear);
        }

        function updateDate() {
            const dateElement = document.getElementById('currentDate');
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const weekday = weekdays[now.getDay()];

            dateElement.textContent = `${year}å¹´${month}æœˆ${day}æ—¥ æ˜ŸæœŸ${weekday}`;
        }

        function getTodayString() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }

        function getAllRecords() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveRecord(record) {
            const records = getAllRecords();
            records.unshift(record);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        function getTodayRecords() {
            const today = getTodayString();
            const allRecords = getAllRecords();
            return allRecords.filter(record => record.date === today);
        }

        function updateStats() {
            const todayRecords = getTodayRecords();
            const allRecords = getAllRecords();

            document.getElementById('todayCount').textContent = todayRecords.length;
            document.getElementById('totalCount').textContent = allRecords.length;

            const progress = Math.min(todayRecords.length, DAILY_GOAL);
            const percentage = progress / DAILY_GOAL;
            const circumference = 2 * Math.PI * 50;
            const offset = circumference * (1 - percentage);

            document.getElementById('progressCircle').style.strokeDashoffset = offset;
            document.getElementById('progressText').textContent = `${progress}/${DAILY_GOAL}`;
        }

        function loadRecords() {
            const todayRecords = getTodayRecords();
            const recordsList = document.getElementById('recordsList');

            if (todayRecords.length === 0) {
                recordsList.innerHTML = '<p class="no-records">è¿˜æ²¡æœ‰æ‰“å¡è®°å½•ï¼Œå¿«æ¥å–æ°´å§ï¼</p>';
                return;
            }

            let html = '';
            todayRecords.forEach((record, index) => {
                html += `
                    <div class="record-item">
                        <div class="record-icon">ğŸ’§</div>
                        <div class="record-info">
                            <div class="record-time">${record.time}</div>
                            <div class="record-date">${record.date}</div>
                        </div>
                        <div class="record-number">ç¬¬${todayRecords.length - index}æ¬¡</div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        function handleCheckIn() {
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;

            const record = {
                date: getTodayString(),
                time: timeString,
                timestamp: now.getTime()
            };

            saveRecord(record);

            const btn = document.getElementById('checkInBtn');
            btn.classList.add('animate');
            setTimeout(() => btn.classList.remove('animate'), 300);

            updateStats();
            loadRecords();

            if (navigator.vibrate) {
                navigator.vibrate(100);
            }

            const todayCount = getTodayRecords().length;
            if (todayCount >= DAILY_GOAL) {
                showToast('ğŸ‰ æ­å–œï¼å·²å®Œæˆä»Šæ—¥ç›®æ ‡ï¼');
            } else {
                showToast('âœ… æ‰“å¡æˆåŠŸï¼ç»§ç»­åŠ æ²¹ï¼');
            }
        }

        function handleClear() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem(STORAGE_KEY);
                updateStats();
                loadRecords();
                showToast('ğŸ—‘ï¸ è®°å½•å·²æ¸…ç©º');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
