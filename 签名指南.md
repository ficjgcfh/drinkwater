# Android APK 签名指南

## 为什么需要签名？

发布版的 APK 必须经过签名才能：
- 在设备上安装
- 上传到 Google Play Store
- 保证应用完整性和来源可信

## 签名步骤

### 1. 生成密钥库

```bash
keytool -genkey -v -keystore drinkwater-release-key.keystore -alias drinkwater -keyalg RSA -keysize 2048 -validity 10000
```

执行后会提示输入：
- 密钥库密码（记住这个密码！）
- 您的姓名
- 组织单位
- 组织名称
- 城市
- 省份
- 国家代码（中国填 CN）

**重要**: 妥善保管生成的 `.keystore` 文件和密码，丢失后无法恢复！

### 2. 配置 build.json

在项目根目录创建 `build.json` 文件：

```json
{
  "android": {
    "release": {
      "keystore": "drinkwater-release-key.keystore",
      "storePassword": "你的密钥库密码",
      "alias": "drinkwater",
      "password": "你的密钥密码",
      "keystoreType": ""
    }
  }
}
```

**重要**: 不要将 `build.json` 提交到 Git！添加到 `.gitignore`：

```bash
echo "build.json" >> .gitignore
echo "*.keystore" >> .gitignore
```

### 3. 构建签名的 APK

```bash
cordova build android --release
```

签名后的 APK 位置：
```
platforms/android/app/build/outputs/apk/release/app-release.apk
```

### 4. 验证签名

```bash
jarsigner -verify -verbose -certs platforms/android/app/build/outputs/apk/release/app-release.apk
```

应该看到 "jar verified" 的提示。

## 手动签名（如果自动签名失败）

### 1. 构建未签名的 APK

```bash
cordova build android --release
```

### 2. 对齐 APK

```bash
zipalign -v -p 4 platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk app-aligned.apk
```

### 3. 签名 APK

```bash
apksigner sign --ks drinkwater-release-key.keystore --out drinkwater-signed.apk app-aligned.apk
```

### 4. 验证签名

```bash
apksigner verify drinkwater-signed.apk
```

## 最佳实践

1. **密钥库安全**
   - 将密钥库备份到安全位置
   - 不要提交到版本控制
   - 使用强密码

2. **版本管理**
   - 每次发布前更新版本号（在 config.xml）
   - 记录每个版本使用的密钥

3. **发布检查清单**
   - [ ] 更新版本号
   - [ ] 测试所有功能
   - [ ] 构建签名 APK
   - [ ] 验证签名
   - [ ] 在真机测试
   - [ ] 准备应用商店资源（截图、描述等）

## 常见问题

### Q: 忘记密钥库密码怎么办？
A: 无法恢复，只能重新生成密钥库。如果应用已发布，将无法更新，只能发布新应用。

### Q: 密钥库丢失了怎么办？
A: 无法恢复，后果同上。务必做好备份！

### Q: 签名失败怎么办？
A: 检查：
- 密钥库路径是否正确
- 密码是否正确
- build.json 格式是否正确
- Java 环境是否配置正确

### Q: 可以使用调试签名发布吗？
A: 不建议。调试签名：
- 有效期只有1年
- 不适合正式发布
- 可能被应用商店拒绝

## 上传到应用商店

### Google Play Store

1. 访问 https://play.google.com/console/
2. 创建应用
3. 填写应用信息
4. 上传签名的 APK
5. 设置定价和分发
6. 提交审核

### 国内应用商店

常见应用商店：
- 华为应用市场
- 小米应用商店
- OPPO 软件商店
- vivo 应用商店
- 应用宝（腾讯）
- 豌豆荚
- 360 手机助手

每个商店都有自己的开发者平台和上传流程，请参考各自的文档。

## 版本号管理

在 `config.xml` 中：

```xml
<widget id="com.ruthirsty.drinkwater" version="1.0.0" ...>
```

版本号格式：`主版本.次版本.修订号`

- 主版本：重大更新
- 次版本：新功能
- 修订号：bug修复

例如：
- 1.0.0 - 初始版本
- 1.1.0 - 添加新功能
- 1.1.1 - 修复bug
- 2.0.0 - 重大改版

## 构建不同的版本

### 开发版（Debug）
```bash
cordova build android
```
用途：开发测试

### 发布版（Release）
```bash
cordova build android --release
```
用途：正式发布

### 指定架构
```bash
# 只构建 ARM64
cordova build android --release -- --packageType=apk --arch=arm64-v8a

# 只构建 ARMv7
cordova build android --release -- --packageType=apk --arch=armeabi-v7a

# 构建所有架构
cordova build android --release -- --packageType=apk
```

## 总结

签名是发布应用的必要步骤，务必：
1. ✅ 妥善保管密钥库
2. ✅ 记住密码
3. ✅ 定期备份
4. ✅ 不要泄露

祝发布顺利！
